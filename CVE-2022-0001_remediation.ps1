# Check if Hyperthreading is enabled
$cpuInfo = Get-WmiObject -Query "SELECT NumberOfCores,NumberOfLogicalProcessors FROM Win32_Processor"
$numberOfCores = $cpuInfo.NumberOfCores
$numberOfLogicalProcessors = $cpuInfo.NumberOfLogicalProcessors
$hyperThreadingEnabled = $numberOfCores -ne $numberOfLogicalProcessors

# Set registry keys based on Hyperthreading status
if ($hyperThreadingEnabled) {
    Write-Output "Hyperthreading is ENABLED"
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "FeatureSettingsOverride" -Value 8388680
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "FeatureSettingsOverrideMask" -Value 3
} else {
    Write-Output "Hyperthreading is DISABLED"
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "FeatureSettingsOverride" -Value 8396872
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "FeatureSettingsOverrideMask" -Value 3
}

# Check if Hyper-V is enabled
$hyperVEnabled = (Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All).State -eq "Enabled"


if ($hyperVEnabled) {
    Write-Output "Hyper-V is ENABLED"
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" -Name "MinVmVersionForCpuBasedMitigations" -Value "1.0"
} else {
    Write-Output "Hyper-V is DISABLED"
}

Write-Output "Registry settings have been applied for Speculative Execution Vulnerabilities mitigation."

# Inform the user to reboot the system
Write-Output "Please reboot the system for the changes to take effect."
