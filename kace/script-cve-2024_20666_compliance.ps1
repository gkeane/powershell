#https://nvd.nist.gov/vuln/detail/CVE-2024-20666
$patched_Win11_22H2 = [version]"10.0.22621.3007"
$patched_Win11_23H2 = [version]"10.0.22631.3007"
$patched_Win11_21H2 = [version]"10.0.22000.2713"
$patched_Win10_22H2 = [version]"10.0.19045.3930"
$patched_Win10_21H2 = [version]"10.0.19044.3930"
$patched_Win10_20H2 = [version]"10.0.19042.3930"
$patched_Win10_20H1 = [version]"10.0.19041.3930"
$patched_Win10_1809 = [version]"10.0.17763.5329"
$patched_Win10_1607 = [version]"10.0.14393.6614"
$patched_Win10_1507 = [version]"10.0.10240.20402"
$out = "Non-Compliant"
#Get current WinRE .wim location
try{
$winre_loc = (reagentc /info | findstr '\\?\GLOBALROOT\device').replace('Windows RE location: ', '').TRIM()

    if (-not $winre_loc) {
        {$out =  "Compliant - NO Recovery"}; 
    }
}
catch {
    $out =  "Compliant - NO Recovery"
}
#Get current WinRE build version
$temp = (Dism /Get-ImageInfo /ImageFile:$winre_loc\winre.wim /index:1).Split([System.Environment]::NewLine)

foreach ($line in $temp){
    if ($line -match "Version :"){
    $winre_major_ver = $line.Split()[2]
    } else {
    if ($line -match "ServicePack Build :"){
    $winre_minor_ver = $line.Split()[3]
    }
    }
}

$winre_ver = [Version]($winre_major_ver + "." + $winre_minor_ver)

#Check current WinRE patch level against January patch level for compliance.
switch ($winre_major_ver) {
   "10.0.22631"  {if ($winre_ver -lt $patched_Win11_23H2){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.22621"  {if ($winre_ver -lt $patched_Win11_22H2){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.22000"  {if ($winre_ver -lt $patched_Win11_21H2){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.19045"  {if ($winre_ver -lt $patched_Win10_22H2){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.19044"  {if ($winre_ver -lt $patched_Win10_21H2){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.19042"  {if ($winre_ver -lt $patched_Win10_20H2){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.19041"  {if ($winre_ver -lt $patched_Win10_20H1){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.17763"  {if ($winre_ver -lt $patched_Win10_1809){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.14393"  {if ($winre_ver -lt $patched_Win10_1607){$out = "Not Compliant"} else {$out = "Compliant"}; }
   "10.0.10240"  {if ($winre_ver -lt $patched_Win10_1507){$out = "Not Compliant"} else {$out = "Compliant"}; }
   default {{$out = "Not Compliant"}; }  # optional
}

try {
    $out | Out-File -FilePath c:\Programdata\Quest\KACE\user\winre_comp.txt
    Write-Host "wrote out file"
    }
    catch {
        Write-Host "failed to file"
    }